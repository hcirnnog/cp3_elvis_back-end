<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener - DeepURL</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo">URL Shortener</div>
        <nav>
            <ul>
                <li><a href="#home">Home</a></li>
                <li><a href="#features">Features</a></li>
                <li><a href="#dashboard">Dashboard</a></li>
                <li><a href="#history">Histórico</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero" id="home">
            <h1>Encurte suas URLs com Elegância</h1>
            <p>Crie links curtos personalizados, rastreie acessos e gerencie suas URLs de forma profissional e refinada.</p>
        </section>

        <section class="shortener-form">
            <form id="urlForm">
                <div class="form-group">
                    <label for="longUrl">URL Longa</label>
                    <input type="url" id="longUrl" placeholder="Cole sua URL longa aqui" required>
                </div>
                <div class="form-group">
                    <label for="shortCode">Código Curto Personalizado</label>
                    <input type="text" id="shortCode" placeholder="Ex: meu-link">
                </div>
                <div class="form-group">
                    <label for="category">Categoria</label>
                    <select id="category">
                        <option value="">Selecione</option>
                        <option value="social">Social</option>
                        <option value="business">Negócios</option>
                        <option value="personal">Pessoal</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Encurtar URL</button>
            </form>
            <div id="result" class="result"></div>
        </section>

        <section class="url-list" id="dashboard">
            <h2>Suas URLs Criadas</h2>
            <div id="urlList"></div>
        </section>

        <section class="creation-history" id="history">
            <h2>Histórico de Criações</h2>
            <div id="creationHistoryList"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2023 URL Shortener. Todos os direitos reservados.</p>
    </footer>

    <script>
        const apiBase = 'http://localhost:5000';

        document.getElementById('urlForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const longUrl = document.getElementById('longUrl').value.trim();
            const shortCode = document.getElementById('shortCode').value.trim() || generateShortCode();
            const category = document.getElementById('category').value;
            const resultDiv = document.getElementById('result');

            if (!longUrl) {
                showResult('Por favor, insira uma URL válida.', false);
                return;
            }

            try {
                const response = await fetch(`${apiBase}/api/urls`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        short_code: shortCode,
                        destination_url: longUrl,
                        category: category
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const shortUrl = `${window.location.origin}/${data.data.short_code}`;
                    showResult(`URL encurtada: <a href="${shortUrl}" target="_blank">${shortUrl}</a>`, true);
                    loadUrls();
                    loadCreationHistory();
                } else {
                    showResult(data.error || 'Erro ao encurtar URL.', false);
                }
            } catch (error) {
                showResult('Erro de conexão.', false);
            }
        });

        function showResult(message, isSuccess) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${isSuccess ? 'success' : 'error'}`;
            resultDiv.style.display = 'block';
        }

        function generateShortCode() {
            return Math.random().toString(36).substr(2, 8);
        }

        async function loadUrls() {
            try {
                const response = await fetch(`${apiBase}/api/urls`);
                const data = await response.json();

                if (response.ok) {
                    const urlListDiv = document.getElementById('urlList');
                    urlListDiv.innerHTML = '';

                    data.data.forEach(url => {
                        const urlItem = document.createElement('div');
                        urlItem.className = 'url-item';
                        urlItem.innerHTML = `
                            <div class="url-info">
                                <strong>${url.short_code}</strong> → <a href="${url.destination_url}" target="_blank">${url.destination_url}</a>
                                <br><small>Categoria: ${url.category || 'N/A'}</small>
                            </div>
                            <div class="url-actions">
                                <span>Acessos: ${url.access_count}</span>
                                <a href="#" onclick="showStats('${url.short_code}')"><i class="fas fa-chart-bar"></i> Stats</a>
                                <a href="#" onclick="editUrl('${url.short_code}')"><i class="fas fa-edit"></i> Editar</a>
                                <a href="#" onclick="deleteUrl('${url.short_code}')"><i class="fas fa-trash"></i> Deletar</a>
                            </div>
                        `;
                        urlListDiv.appendChild(urlItem);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar URLs:', error);
            }
        }

        async function loadCreationHistory() {
            try {
                const response = await fetch(`${apiBase}/api/creation-history`);
                const data = await response.json();

                if (response.ok) {
                    const historyDiv = document.getElementById('creationHistoryList');
                    historyDiv.innerHTML = '';

                    data.data.forEach(log => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                            <strong>${log.short_code}</strong> → <a href="${log.destination_url}" target="_blank">${log.destination_url}</a>
                            <br><small>Criado em: ${log.created_at} | IP: ${log.client_ip}</small>
                        `;
                        historyDiv.appendChild(historyItem);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
            }
        }

        async function showStats(shortCode) {
            try {
                const response = await fetch(`${apiBase}/api/urls/${shortCode}/stats`);
                const data = await response.json();

                if (response.ok) {
                    alert(`Estatísticas para ${shortCode}:\nAcessos: ${data.data.access_count}\nCriado em: ${data.data.created_at}`);
                } else {
                    alert('Erro ao carregar stats.');
                }
            } catch (error) {
                alert('Erro de conexão.');
            }
        }

        function editUrl(shortCode) {
            alert('Função de edição em desenvolvimento.');
        }

        function deleteUrl(shortCode) {
            if (confirm('Tem certeza que deseja deletar esta URL?')) {
                fetch(`${apiBase}/api/urls/${shortCode}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('URL deletada com sucesso.');
                            loadUrls();
                            loadCreationHistory();
                        } else {
                            alert('Erro ao deletar URL.');
                        }
                    })
                    .catch(error => alert('Erro de conexão.'));
            }
        }

        window.onload = function() {
            loadUrls();
            loadCreationHistory();
        };
    </script>
</body>
</html>
